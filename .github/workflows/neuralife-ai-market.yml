name: Deploy All Frontend Apps to GitHub Pages

on:
    push:
        branches:
            - main
        # Trigger the workflow if anything changes in the frontend folder or the root index.html
        paths:
            - "frontend/**"
            - "index.html"

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"
                  cache-dependency-path: "**/yarn.lock" # Cache for all projects

            # --- Build Neuralife AI Market ---
            - name: Build Neuralife AI Market
              run: |
                  cd frontend/neuralife-ai-market
                  yarn install --frozen-lockfile
                  yarn build
                  cd ../.. # Go back to the root

            # --- Build Other Apps (Example for later) ---
            # - name: Build Upgrade Agent
            #   run: |
            #     cd frontend/upgrade-agent
            #     npm install --legacy-peer-deps
            #     npm run build
            #     cd ../..

            # --- Assemble Site for Deployment ---
            # --- Assemble Site for Deployment ---
            - name: Assemble site
              run: |
                  # Create the root directory for deployment
                  mkdir -p _site/neuralife-ai-market

                  # Copy the root landing page
                  cp index.html _site/

                  # Copy the built app to its sub-path
                  cp -r frontend/neuralife-ai-market/dist/* _site/neuralife-ai-market/

                  # When you add another app, you would copy it here too
                  # mkdir -p _site/upgrade-agent
                  # cp -r frontend/upgrade-agent/dist/* _site/upgrade-agent/

            - name: Setup Pages
              uses: actions/configure-pages@v5

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  # Upload the assembled site from the _site directory
                  path: ./_site

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Print deployment URL
              run: 'echo "Page deployed at: ${{ steps.deployment.outputs.page_url }}"'
