name: Deploy Backend to EC2

on:
    push:
        branches: [main]
        paths:
            - "backend/**"

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Check AWS CLI version
              run: aws --version

            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.AWS_HOST }}
                  username: ${{ secrets.AWS_USERNAME }}
                  key: ${{ secrets.AWS_SSH_KEY }}
                  script: |
                      cd ~/personalprojects

                      # FORCE UPDATE: Fetch and hard reset to ensure server matches GitHub exactly
                      git fetch origin main
                      git reset --hard origin/main

                      cd backend

                      # Fetch secrets from AWS Parameter Store and write to .env
                      MONGODB_URL=$(aws ssm get-parameter --name "/myapp/MONGODB_URL" --with-decryption --query "Parameter.Value" --output text)
                      DATABASE_NAME=$(aws ssm get-parameter --name "/myapp/DATABASE_NAME" --query "Parameter.Value" --output text)
                      SECRET_KEY=$(aws ssm get-parameter --name "/myapp/SECRET_KEY" --with-decryption --query "Parameter.Value" --output text)
                      GOOGLE_API_KEY=$(aws ssm get-parameter --name "/myapp/GOOGLE_API_KEY" --with-decryption --query "Parameter.Value" --output text)

                      cat > .env <<EOF
                      MONGODB_URL=$MONGODB_URL
                      DATABASE_NAME=$DATABASE_NAME
                      SECRET_KEY=$SECRET_KEY
                      GOOGLE_API_KEY=$GOOGLE_API_KEY
                      EOF

                      docker compose down --remove-orphans
                      docker compose up --build -d
                      docker image prune -f
