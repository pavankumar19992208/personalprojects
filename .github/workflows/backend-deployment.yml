name: Deploy Backend to EC2

on:
    push:
        branches: [main]
        paths:
            - "backend/**"

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.AWS_HOST }}
                  username: ${{ secrets.AWS_USERNAME }}
                  key: ${{ secrets.AWS_SSH_KEY }}
                  script: |
                      # Navigate to the project root
                      cd ~/personalprojects

                      # Pull the latest code
                      git pull origin main

                      # Use docker compose (v2) to rebuild and restart
                      # Note: docker-compose.yml is now at the root of ~/personalprojects/backend/
                      # But since we run from root, we point to the file if needed, OR
                      # if you moved docker-compose.yml to backend/, run from there.

                      # OPTION A: If docker-compose.yml is in backend/ folder:
                      cd backend
                      docker compose up --build -d

                      # Clean up unused images
                      docker image prune -f
